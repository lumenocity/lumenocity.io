#!/bin/sh
set -o errexit

source ./.env

rm -rf ./build

echo '=> Building...'
taskr build

echo '=> Deploying...'
# cp build/index.html build/200.html
mkdir build/.well-known
cp federation/stellar.toml build/.well-known/stellar.toml
surge build --domain=${DEPLOY_DOMAIN}

echo '=> Purging Cloudflare cache...'
curl -X DELETE "https://api.cloudflare.com/client/v4/zones/${CLOUDFLARE_ZONE_ID}/purge_cache" \
-H "X-Auth-Email: ${CLOUDFLARE_AUTH_EMAIL}" \
-H "X-Auth-Key: ${CLOUDFLARE_API_KEY}" \
-H "Content-Type: application/json" \
--data '{"purge_everything":true}'

echo '\n=> Cleaning up...'
#rm -rf ./build